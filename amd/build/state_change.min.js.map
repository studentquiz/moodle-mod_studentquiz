{"version":3,"sources":["../src/state_change.js"],"names":["define","$","Ajax","Notification","t","SELECTOR","STATE_SELECT","CHANGE_STATE_BUTTON","STATE_VALUE_INPUT","SUBMIT_STATE_BUTTON","CHANGE_STATE_NOTIFICATION","init","lastSelectedState","val","document","on","stateChangeSelect","changeStateButton","stateValueInput","submitStateButton","removeAttr","attr","pendingPromise","addPendingJSPromise","require","LoadingIcon","parentElement","addIconToContainerRemoveOnCompletion","args","courseid","cmid","questionid","state","failure","promise","call","methodname","then","results","alert","status","message","resolve","window","opener","location","reload","fail","pendingKey","M","util","js_pending","Deferred","js_complete","arguments","catch","exception"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for state change dialog\n *\n * @package mod_studentquiz\n * @author Huong Nguyen <huongnv13@gmail.com>\n * @copyright 2019 HSR (http://www.hsr.ch)\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n\n    var t = {\n\n        SELECTOR: {\n            STATE_SELECT: '#menustatetype',\n            CHANGE_STATE_BUTTON: 'div.singlebutton.continue_state_change [type=submit]',\n            STATE_VALUE_INPUT: 'input[name=state]',\n            SUBMIT_STATE_BUTTON: '#change_state',\n            CHANGE_STATE_NOTIFICATION: 'span.change-question-state'\n        },\n\n        init: function() {\n\n            var lastSelectedState = $(t.SELECTOR.STATE_SELECT).val();\n\n            // TODO: Something rerenders or manipulates the modal elements, so the event has to be attached to the\n            // document - see #278. Better would be using the dialog framework similiar to the comment_area instead of\n            // putting the dialog together manually in the renderer functions.\n            $(document).on('change', t.SELECTOR.STATE_SELECT, {}, function() {\n                // Since it happens that the modal elements gets rerendered or manipulated in some way, the elements\n                // need to be obtained freshly.\n                var stateChangeSelect = $(t.SELECTOR.STATE_SELECT);\n                var changeStateButton = $(t.SELECTOR.CHANGE_STATE_BUTTON);\n                var stateValueInput = $(t.SELECTOR.STATE_VALUE_INPUT);\n                var submitStateButton = $(t.SELECTOR.SUBMIT_STATE_BUTTON);\n\n                // TODO: None of the render functions preselect the current active option so lastSelectedState is\n                // basically always the first option, whose value is '' as well.\n                if (stateChangeSelect.val() !== '' && stateChangeSelect.val() !== lastSelectedState) {\n                    stateValueInput.val(stateChangeSelect.val());\n                    changeStateButton.removeAttr('disabled');\n                    submitStateButton.removeAttr('disabled');\n                } else {\n                    changeStateButton.attr('disabled', 'disabled');\n                    submitStateButton.attr('disabled', 'disabled');\n                }\n            });\n\n            $(document).on('click', t.SELECTOR.SUBMIT_STATE_BUTTON, {}, function() {\n                // Since it happens that the modal elements gets rerendered or manipulated in some way, the elements\n                // need to be obtained freshly.\n                var stateChangeSelect = $(t.SELECTOR.STATE_SELECT);\n                var submitStateButton = $(t.SELECTOR.SUBMIT_STATE_BUTTON);\n\n                submitStateButton.attr('disabled', 'disabled');\n                var pendingPromise = t.addPendingJSPromise('studentquizStateChange');\n                require(['core/loadingicon'], function(LoadingIcon) {\n                    var parentElement = $(t.SELECTOR.CHANGE_STATE_NOTIFICATION);\n                    LoadingIcon.addIconToContainerRemoveOnCompletion(parentElement, pendingPromise);\n                });\n                var args = {\n                    courseid: submitStateButton.attr('data-courseid'),\n                    cmid: submitStateButton.attr('data-cmid'),\n                    questionid: submitStateButton.attr('data-questionid'),\n                    state: stateChangeSelect.val()\n                };\n                var failure;\n                var promise = Ajax.call([{methodname: 'mod_studentquiz_set_state', args: args}], true, true);\n                promise[0].then(function(results) {\n                    Notification.alert(results.status, results.message);\n                    pendingPromise.resolve();\n                    lastSelectedState = stateChangeSelect.val();\n                    // Reload the Studentquiz page.\n                    window.opener.location.reload();\n                    // Each then() should return a value or throw (promise/always-return).\n                    return;\n                }).fail(failure);\n            });\n        },\n\n        /**\n         * Add Pending Promise to current session.\n         *\n         *\n         * @param {string} pendingKey JSPending key\n         * @returns {*|jQuery|{}} Pending Promise\n         */\n        addPendingJSPromise: function(pendingKey) {\n            M.util.js_pending(pendingKey);\n\n            var pendingPromise = $.Deferred();\n            pendingPromise.then(function() {\n                M.util.js_complete(pendingKey);\n                return arguments[0];\n            }).catch(Notification.exception);\n\n            return pendingPromise;\n        },\n    };\n\n    return t;\n});\n"],"file":"state_change.min.js"}